name: CI

on:
  push:
    branches: [ master, main, feature/* ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test:
    name: Test on iOS ${{ matrix.destination }}
    runs-on: macos-14
    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
          - 'platform=iOS Simulator,name=iPhone 14,OS=16.4'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: List available Xcode versions
      run: ls /Applications/ | grep Xcode
    
    - name: List available Xcode versions
      run: ls /Applications/ | grep Xcode
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Build for testing
      run: |
        xcodebuild clean build-for-testing \
          -scheme SVSwiper \
          -destination '${{ matrix.destination }}' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Run tests
      run: |
        xcodebuild test-without-building \
          -scheme SVSwiper \
          -destination '${{ matrix.destination }}' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  spm-build:
    name: Swift Package Manager Build
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Build Swift Package for iOS
      run: |
        xcodebuild build \
          -scheme SVSwiper \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Build Swift Package for iOS Simulator
      run: |
        xcodebuild build \
          -scheme SVSwiper \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Run Swift Package Tests
      run: |
        xcodebuild test \
          -scheme SVSwiper \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  swiftlint:
    name: SwiftLint
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: swiftlint lint --strict
      continue-on-error: true

  cocoapods:
    name: CocoaPods Validation
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install CocoaPods
      run: gem install cocoapods
    
    - name: Validate Podspec
      run: pod lib lint --allow-warnings
      continue-on-error: true
